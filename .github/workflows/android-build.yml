name: Android Build and Upload APK

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
    
    env:
      ANDROID_SDK_ROOT: ${{ runner.temp }}/android-sdk
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle
      
      - name: Cache Gradle wrapper
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/wrapper
            ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
      
      - name: Install Android SDK command-line tools
        run: |
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
          cd $ANDROID_SDK_ROOT/cmdline-tools
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
          unzip -q commandlinetools-linux-11076708_latest.zip
          mv cmdline-tools latest
          rm commandlinetools-linux-11076708_latest.zip
          echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH
          echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH
      
      - name: Accept SDK licenses
        run: |
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
      
      - name: Install Android SDK components
        run: |
          $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-33" "build-tools;33.0.2"
      
      - name: Print Java version
        run: java -version
      
      - name: Print Gradle version
        run: ./gradlew -v
      
      - name: List installed SDK components
        run: $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --list_installed
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build Debug APK
        run: ./gradlew assembleDebug
      
      # Optional: Build Release APK with signing
      # To enable signed release builds, add the following secrets to your repository:
      # - KEYSTORE_BASE64: Base64-encoded keystore file (use: base64 -w 0 your-keystore.jks)
      # - KEYSTORE_PASSWORD: Password for the keystore
      # - KEY_ALIAS: Alias of the key in the keystore
      # - KEY_PASSWORD: Password for the key
      # The keystore will be decoded and saved to: ${{ github.workspace }}/release.keystore
      # Configure your app/build.gradle to read signing config from environment variables or gradle properties
      
      - name: Decode keystore (if secrets are present)
        if: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > ${{ github.workspace }}/release.keystore
          echo "KEYSTORE_FILE=${{ github.workspace }}/release.keystore" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV
      
      - name: Build Release APK (signed)
        if: ${{ secrets.KEYSTORE_BASE64 }}
        run: ./gradlew assembleRelease
      
      # Uncomment below to build release APK without signing (not recommended for production)
      # - name: Build Release APK (unsigned)
      #   run: ./gradlew assembleRelease
      
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-apks
          path: |
            **/build/outputs/apk/**/*.apk
          if-no-files-found: warn
      
      - name: Upload AAB artifacts
        uses: actions/upload-artifact@v4
        with:
          name: app-bundles
          path: |
            **/build/outputs/bundle/**/*.aab
          if-no-files-found: ignore
